/* Copyright (C) Lech H. Conde <lech@zyrx.com.mx>, GNU/GPL Version 3 or latter (http://www.gnu.org/licenses/gpl.html) */
(function(e){function t(e,n,r){this.extend(t,google.maps.OverlayView);this.map_=e;this.markers_=[];this.clusters_=[];this.sizes=[53,56,66,78,90];this.styles_=[];this.ready_=!1;r=r||{};this.gridSize_=r.gridSize||60;this.minClusterSize_=r.minimumClusterSize||2;this.maxZoom_=r.maxZoom||null;this.styles_=r.styles||[];this.imagePath_=r.imagePath||this.MARKER_CLUSTER_IMAGE_PATH_;this.imageExtension_=r.imageExtension||this.MARKER_CLUSTER_IMAGE_EXTENSION_;this.zoomOnClick_=!0;void 0!=r.zoomOnClick&&(this.zoomOnClick_=r.zoomOnClick);this.averageCenter_=!1;void 0!=r.averageCenter&&(this.averageCenter_=r.averageCenter);this.setupStyles_();this.setMap(e);this.prevZoom_=this.map_.getZoom();var i=this;google.maps.event.addListener(this.map_,"zoom_changed",function(){var e=i.map_.getZoom();if(i.prevZoom_!=e){i.prevZoom_=e;i.resetViewport()}});google.maps.event.addListener(this.map_,"idle",function(){i.redraw()});n&&n.length&&this.addMarkers(n,!1)}function n(e){this.markerClusterer_=e;this.map_=e.getMap();this.gridSize_=e.getGridSize();this.minClusterSize_=e.getMinClusterSize();this.averageCenter_=e.isAverageCenter();this.center_=null;this.markers_=[];this.bounds_=null;this.clusterIcon_=new r(this,e.getStyles(),e.getGridSize())}function r(e,t,n){e.getMarkerClusterer().extend(r,google.maps.OverlayView);this.styles_=t;this.padding_=n||0;this.cluster_=e;this.center_=null;this.map_=e.getMap();this.sums_=this.div_=null;this.visible_=!1;this.setMap(this.map_)}var i=function(){},s=!1,o=!1,u=[];window.google&&google.maps&&(o=s=!0);e.extend(i.prototype,{name:"googlemaps",options:{lat:53.553407,lng:9.992196,marker:!0,popup:!1,text:"",zoom:13,mapCtrl:1,zoomWhl:!0,mapTypeId:"roadmap",typeCtrl:!0,directions:!0,directionsDestUpdate:!0,mainIcon:"red-dot",otherIcon:"blue-dot",iconUrl:"http://maps.google.com/mapfiles/ms/micons/",clusterMarker:!1},markers:[],initialize:function(t,n){this.options.msgFromAddress=$widgetkit.trans.get("FROM_ADDRESS");this.options.msgGetDirections=$widgetkit.trans.get("GET_DIRECTIONS");this.options.msgEmpty=$widgetkit.trans.get("FILL_IN_ADDRESS");this.options.msgNotFound=$widgetkit.trans.get("ADDRESS_NOT_FOUND");this.options.msgAddressNotFound=$widgetkit.trans.get("LOCATION_NOT_FOUND");this.options=e.extend({},this.options,n);this.container=t;o?this.setupMap():u.push(this)},setupMap:function(){var e=this.options;this.map=new google.maps.Map(this.container.get(0),{mapTypeId:e.mapTypeId,center:new google.maps.LatLng(e.lat,e.lng),streetViewControl:e.mapCtrl?true:false,navigationControl:e.mapCtrl,scrollwheel:e.zoomWhl?true:false,mapTypeControl:e.typeCtrl?true:false,zoomControl:e.mapCtrl?true:false,zoomControlOptions:{style:e.mapCtrl==1?google.maps.ZoomControlStyle.DEFAULT:google.maps.ZoomControlStyle.SMALL}});this.infowindow=new google.maps.InfoWindow;if(e.marker)if(e.popup==0){this.map.setCenter(new google.maps.LatLng(e.lat,e.lng));this.map.setZoom(e.zoom)}else this.addMarkerLatLng(e.lat,e.lng,e.text,true);if(e.mapTypeId=="roadmap"){this.map.mapTypeIds=["custom"];this.map.mapTypes.set("custom",new google.maps.StyledMapType([{featureType:"all",elementType:"all",stylers:[{invert_lightness:e.styler_invert_lightness},{hue:e.styler_hue},{saturation:e.styler_saturation},{lightness:e.styler_lightness},{gamma:e.styler_gamma}]}],{name:"CustomStyle"}));this.map.setMapTypeId("custom")}if(e.adresses&&e.adresses.length)for(var n=0;n<e.adresses.length;n++){var r=e.adresses[n];r.lat&&r.lng&&this.addMarkerLatLng(r.lat,r.lng,r.popup,r.center,r.icon)}e.directions&&this.setupDirections();if(e.clusterMarker)this.marker_cluster=new t(this.map,this.markers)},createMarker:function(e,t,n){var r=this,i=this.map,s=this.infowindow,o=new google.maps.MarkerImage(this.options.markerImage?this.options.markerImage:this.options.iconUrl+n+".png",new google.maps.Size(this.options.markerSize,this.options.markerSize),new google.maps.Point(0,0),new google.maps.Point(16,32)),n=n.match("pushpin")?this.options.iconUrl+"pushpin_shadow.png":this.options.iconUrl+"msmarker.shadow.png",n=new google.maps.MarkerImage(n,new google.maps.Size(56,32),new google.maps.Point(0,0),new google.maps.Point(16,32)),u=new google.maps.Marker({position:e,icon:o,shadow:n,map:this.map});google.maps.event.addListener(u,"click",function(){if(t.length){s.setContent(t);s.open(i,u)}if(r.options.directionsDestUpdate){r.options.lat=u.getPosition().lat();r.options.lng=u.getPosition().lng()}});this.markers.push(u);return u},centerMap:function(e,t){this.map.setCenter(new google.maps.LatLng(e,t));this.map.setZoom(this.options.zoom)},addMarkerLatLng:function(e,t,n,r,i){i=i||this.options.otherIcon;if(r)i=this.options.mainIcon;e=new google.maps.LatLng(e,t);i=this.createMarker(e,n,i);if(r){this.map.setCenter(e);this.map.setZoom(this.options.zoom)}if(r&&n&&n.length&&this.options.popup==2){this.infowindow.setContent(n);this.infowindow.open(this.map,i)}},setupDirections:function(){var t=this;this.directionsService=new google.maps.DirectionsService;this.directionsDisplay=new google.maps.DirectionsRenderer({suppressMarkers:true});this.directionsDisplay.setMap(this.map);this.directionsDisplay.setPanel(e("<div>").addClass("directions").css("position","relative").insertAfter(this.container).get(0));var n=e("<p>").append('<label for="from-address">'+this.options.msgFromAddress+"</label>").append('<input type="text" name="address" style="margin:0 5px;" />').append('<button type="submit">'+this.options.msgGetDirections+"</button>");e('<form method="get" action="#"></form>').append(n).insertAfter(this.container).bind("submit",function(n){n.preventDefault();n.stopPropagation();t.setDirections(e(this))})},setDirections:function(e){var t=this;this.container.parent().find("div.alert").remove();e=e.find('input[name="address"]').val();if(e==="")this.showAlert(this.options.msgEmpty);else{e={origin:e,destination:new google.maps.LatLng(this.options.lat,this.options.lng),travelMode:google.maps.DirectionsTravelMode.DRIVING};"unitSystem"in this.options&&(e.unitSystem=this.options.unitSystem);this.directionsService.route(e,function(e,n){n==google.maps.DirectionsStatus.OK?t.directionsDisplay.setDirections(e):t.showAlert(t.options.msgNotFound);var r=new google.maps.Marker({position:e.routes[0].legs[0].start_location,map:t.map,icon:t.options.markerFrom,labelAnchor:new google.maps.Point(3,10)}),i=new google.maps.InfoWindow({content:e.routes[0].legs[0].start_address,maxWidth:200});google.maps.event.addListener(r,"click",function(e){i.open(t.map,this)})})}},showAlert:function(t){e("<div>").addClass("alert").append(e("<strong>").text(t)).insertAfter(this.container)},cmd:function(){var e=arguments,t=e[0]?e[0]:null;this.map[t]&&this.map[t].apply(this.map,Array.prototype.slice.call(e,1))}});e.fn[i.prototype.name]=function(){var t=arguments,n=t[0]?t[0]:null,r=this.data("options");return this.each(function(){if(!s){var o=r.language?r.language:"en",u=document.createElement("script");u.type="text/javascript";u.async=1;u.src=location.protocol+"//maps.google.com/maps/api/js?sensor=";u.src+=r.sensor?"true":"false&language="+o;u.src+="&callback=jQuery.fn.googlemaps.ready";document.body.appendChild(u);s=true}u=e(this);if(i.prototype[n]&&u.data(i.prototype.name)&&n!="initialize")u.data(i.prototype.name)[n].apply(u.data(i.prototype.name),Array.prototype.slice.call(t,1));else if(!n||e.isPlainObject(n)){var c=new i;i.prototype.initialize&&c.initialize.apply(c,e.merge([u],t));u.data(i.prototype.name,c)}else e.error("Method "+n+" does not exist on jQuery."+i.name)})};e.fn[i.prototype.name].ready=function(){for(var e=0;e<u.length;e++)u[e].setupMap&&u[e].setupMap();o=true};t.prototype.MARKER_CLUSTER_IMAGE_PATH_="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m";t.prototype.MARKER_CLUSTER_IMAGE_EXTENSION_="png";t.prototype.extend=function(e,t){return function(e){for(var t in e.prototype)this.prototype[t]=e.prototype[t];return this}.apply(e,[t])};t.prototype.onAdd=function(){this.setReady_(true)};t.prototype.draw=function(){};t.prototype.setupStyles_=function(){if(!this.styles_.length)for(var e=0,t;t=this.sizes[e];e++)this.styles_.push({url:this.imagePath_+(e+1)+"."+this.imageExtension_,height:t,width:t})};t.prototype.fitMapToMarkers=function(){for(var e=this.getMarkers(),t=new google.maps.LatLngBounds,n=0,r;r=e[n];n++)t.extend(r.getPosition());this.map_.fitBounds(t)};t.prototype.setStyles=function(e){this.styles_=e};t.prototype.getStyles=function(){return this.styles_};t.prototype.isZoomOnClick=function(){return this.zoomOnClick_};t.prototype.isAverageCenter=function(){return this.averageCenter_};t.prototype.getMarkers=function(){return this.markers_};t.prototype.getTotalMarkers=function(){return this.markers_.length};t.prototype.setMaxZoom=function(e){this.maxZoom_=e};t.prototype.getMaxZoom=function(){return this.maxZoom_};t.prototype.calculator_=function(e,t){for(var n=0,r=e.length,i=r;i!==0;){i=parseInt(i/10,10);n++}n=Math.min(n,t);return{text:r,index:n}};t.prototype.setCalculator=function(e){this.calculator_=e};t.prototype.getCalculator=function(){return this.calculator_};t.prototype.addMarkers=function(e,t){for(var n=0,r;r=e[n];n++)this.pushMarkerTo_(r);t||this.redraw()};t.prototype.pushMarkerTo_=function(e){e.isAdded=false;if(e.draggable){var t=this;google.maps.event.addListener(e,"dragend",function(){e.isAdded=false;t.repaint()})}this.markers_.push(e)};t.prototype.addMarker=function(e,t){this.pushMarkerTo_(e);t||this.redraw()};t.prototype.removeMarker_=function(e){var t=-1;if(this.markers_.indexOf)t=this.markers_.indexOf(e);else for(var n=0,r;r=this.markers_[n];n++)if(r==e){t=n;break}if(t==-1)return false;e.setMap(null);this.markers_.splice(t,1);return true};t.prototype.removeMarker=function(e,t){var n=this.removeMarker_(e);if(!t&&n){this.resetViewport();this.redraw();return true}return false};t.prototype.removeMarkers=function(e,t){for(var n=false,r=0,i;i=e[r];r++){i=this.removeMarker_(i);n=n||i}if(!t&&n){this.resetViewport();this.redraw();return true}};t.prototype.setReady_=function(e){if(!this.ready_){this.ready_=e;this.createClusters_()}};t.prototype.getTotalClusters=function(){return this.clusters_.length};t.prototype.getMap=function(){return this.map_};t.prototype.setMap=function(e){this.map_=e};t.prototype.getGridSize=function(){return this.gridSize_};t.prototype.setGridSize=function(e){this.gridSize_=e};t.prototype.getMinClusterSize=function(){return this.minClusterSize_};t.prototype.setMinClusterSize=function(e){this.minClusterSize_=e};t.prototype.getExtendedBounds=function(e){var t=this.getProjection(),n=new google.maps.LatLng(e.getNorthEast().lat(),e.getNorthEast().lng()),r=new google.maps.LatLng(e.getSouthWest().lat(),e.getSouthWest().lng()),n=t.fromLatLngToDivPixel(n);n.x=n.x+this.gridSize_;n.y=n.y-this.gridSize_;r=t.fromLatLngToDivPixel(r);r.x=r.x-this.gridSize_;r.y=r.y+this.gridSize_;n=t.fromDivPixelToLatLng(n);t=t.fromDivPixelToLatLng(r);e.extend(n);e.extend(t);return e};t.prototype.isMarkerInBounds_=function(e,t){return t.contains(e.getPosition())};t.prototype.clearMarkers=function(){this.resetViewport(true);this.markers_=[]};t.prototype.resetViewport=function(e){for(var t=0,n;n=this.clusters_[t];t++)n.remove();for(t=0;n=this.markers_[t];t++){n.isAdded=false;e&&n.setMap(null)}this.clusters_=[]};t.prototype.repaint=function(){var e=this.clusters_.slice();this.clusters_.length=0;this.resetViewport();this.redraw();window.setTimeout(function(){for(var t=0,n;n=e[t];t++)n.remove()},0)};t.prototype.redraw=function(){this.createClusters_()};t.prototype.distanceBetweenPoints_=function(e,t){if(!e||!t)return 0;var n=(t.lat()-e.lat())*Math.PI/180,r=(t.lng()-e.lng())*Math.PI/180,n=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e.lat()*Math.PI/180)*Math.cos(t.lat()*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 6371*2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n))};t.prototype.addToClosestCluster_=function(e){var t=4e4,r=null;e.getPosition();for(var i=0,s;s=this.clusters_[i];i++){var o=s.getCenter();if(o){o=this.distanceBetweenPoints_(o,e.getPosition());if(o<t){t=o;r=s}}}if(r&&r.isMarkerInClusterBounds(e))r.addMarker(e);else{s=new n(this);s.addMarker(e);this.clusters_.push(s)}};t.prototype.createClusters_=function(){if(this.ready_)for(var e=this.getExtendedBounds(new google.maps.LatLngBounds(this.map_.getBounds().getSouthWest(),this.map_.getBounds().getNorthEast())),t=0,n;n=this.markers_[t];t++)!n.isAdded&&this.isMarkerInBounds_(n,e)&&this.addToClosestCluster_(n)};n.prototype.isMarkerAlreadyAdded=function(e){if(this.markers_.indexOf)return this.markers_.indexOf(e)!=-1;for(var t=0,n;n=this.markers_[t];t++)if(n==e)return true;return false};n.prototype.addMarker=function(e){if(this.isMarkerAlreadyAdded(e))return false;if(this.center_){if(this.averageCenter_){var t=this.markers_.length+1,n=(this.center_.lat()*(t-1)+e.getPosition().lat())/t,t=(this.center_.lng()*(t-1)+e.getPosition().lng())/t;this.center_=new google.maps.LatLng(n,t);this.calculateBounds_()}}else{this.center_=e.getPosition();this.calculateBounds_()}e.isAdded=true;this.markers_.push(e);n=this.markers_.length;n<this.minClusterSize_&&e.getMap()!=this.map_&&e.setMap(this.map_);if(n==this.minClusterSize_)for(t=0;t<n;t++)this.markers_[t].setMap(null);n>=this.minClusterSize_&&e.setMap(null);this.updateIcon();return true};n.prototype.getMarkerClusterer=function(){return this.markerClusterer_};n.prototype.getBounds=function(){for(var e=new google.maps.LatLngBounds(this.center_,this.center_),t=this.getMarkers(),n=0,r;r=t[n];n++)e.extend(r.getPosition());return e};n.prototype.remove=function(){this.clusterIcon_.remove();this.markers_.length=0;delete this.markers_};n.prototype.getSize=function(){return this.markers_.length};n.prototype.getMarkers=function(){return this.markers_};n.prototype.getCenter=function(){return this.center_};n.prototype.calculateBounds_=function(){this.bounds_=this.markerClusterer_.getExtendedBounds(new google.maps.LatLngBounds(this.center_,this.center_))};n.prototype.isMarkerInClusterBounds=function(e){return this.bounds_.contains(e.getPosition())};n.prototype.getMap=function(){return this.map_};n.prototype.updateIcon=function(){var e=this.map_.getZoom(),t=this.markerClusterer_.getMaxZoom();if(t&&e>t)for(e=0;t=this.markers_[e];e++)t.setMap(this.map_);else if(this.markers_.length<this.minClusterSize_)this.clusterIcon_.hide();else{e=this.markerClusterer_.getStyles().length;e=this.markerClusterer_.getCalculator()(this.markers_,e);this.clusterIcon_.setCenter(this.center_);this.clusterIcon_.setSums(e);this.clusterIcon_.show()}};r.prototype.triggerClusterClick=function(){var e=this.cluster_.getMarkerClusterer();google.maps.event.trigger(e,"clusterclick",this.cluster_);e.isZoomOnClick()&&this.map_.fitBounds(this.cluster_.getBounds())};r.prototype.onAdd=function(){this.div_=document.createElement("DIV");if(this.visible_){this.div_.style.cssText=this.createCss(this.getPosFromLatLng_(this.center_));this.div_.innerHTML=this.sums_.text}this.getPanes().overlayMouseTarget.appendChild(this.div_);var e=this;google.maps.event.addDomListener(this.div_,"click",function(){e.triggerClusterClick()})};r.prototype.getPosFromLatLng_=function(e){e=this.getProjection().fromLatLngToDivPixel(e);e.x=e.x-parseInt(this.width_/2,10);e.y=e.y-parseInt(this.height_/2,10);return e};r.prototype.draw=function(){if(this.visible_){var e=this.getPosFromLatLng_(this.center_);this.div_.style.top=e.y+"px";this.div_.style.left=e.x+"px"}};r.prototype.hide=function(){if(this.div_)this.div_.style.display="none";this.visible_=false};r.prototype.show=function(){if(this.div_){this.div_.style.cssText=this.createCss(this.getPosFromLatLng_(this.center_));this.div_.style.display=""}this.visible_=true};r.prototype.remove=function(){this.setMap(null)};r.prototype.onRemove=function(){if(this.div_&&this.div_.parentNode){this.hide();this.div_.parentNode.removeChild(this.div_);this.div_=null}};r.prototype.setSums=function(e){this.sums_=e;this.text_=e.text;this.index_=e.index;if(this.div_)this.div_.innerHTML=e.text;this.useStyle()};r.prototype.useStyle=function(){var e=Math.max(0,this.sums_.index-1),e=Math.min(this.styles_.length-1,e),e=this.styles_[e];this.url_=e.url;this.height_=e.height;this.width_=e.width;this.textColor_=e.textColor;this.anchor_=e.anchor;this.textSize_=e.textSize;this.backgroundPosition_=e.backgroundPosition};r.prototype.setCenter=function(e){this.center_=e};r.prototype.createCss=function(e){var t=[];t.push("background-image:url("+this.url_+");");t.push("background-position:"+(this.backgroundPosition_?this.backgroundPosition_:"0 0")+";");if(typeof this.anchor_==="object"){typeof this.anchor_[0]==="number"&&this.anchor_[0]>0&&this.anchor_[0]<this.height_?t.push("height:"+(this.height_-this.anchor_[0])+"px; padding-top:"+this.anchor_[0]+"px;"):t.push("height:"+this.height_+"px; line-height:"+this.height_+"px;");typeof this.anchor_[1]==="number"&&this.anchor_[1]>0&&this.anchor_[1]<this.width_?t.push("width:"+(this.width_-this.anchor_[1])+"px; padding-left:"+this.anchor_[1]+"px;"):t.push("width:"+this.width_+"px; text-align:center;")}else t.push("height:"+this.height_+"px; line-height:"+this.height_+"px; width:"+this.width_+"px; text-align:center;");t.push("cursor:pointer; top:"+e.y+"px; left:"+e.x+"px; color:"+(this.textColor_?this.textColor_:"black")+"; position:absolute; font-size:"+(this.textSize_?this.textSize_:11)+"px; font-family:Arial,sans-serif; font-weight:bold");return t.join("")};window.MarkerClusterer=t;t.prototype.addMarker=t.prototype.addMarker;t.prototype.addMarkers=t.prototype.addMarkers;t.prototype.clearMarkers=t.prototype.clearMarkers;t.prototype.fitMapToMarkers=t.prototype.fitMapToMarkers;t.prototype.getCalculator=t.prototype.getCalculator;t.prototype.getGridSize=t.prototype.getGridSize;t.prototype.getExtendedBounds=t.prototype.getExtendedBounds;t.prototype.getMap=t.prototype.getMap;t.prototype.getMarkers=t.prototype.getMarkers;t.prototype.getMaxZoom=t.prototype.getMaxZoom;t.prototype.getStyles=t.prototype.getStyles;t.prototype.getTotalClusters=t.prototype.getTotalClusters;t.prototype.getTotalMarkers=t.prototype.getTotalMarkers;t.prototype.redraw=t.prototype.redraw;t.prototype.removeMarker=t.prototype.removeMarker;t.prototype.removeMarkers=t.prototype.removeMarkers;t.prototype.resetViewport=t.prototype.resetViewport;t.prototype.repaint=t.prototype.repaint;t.prototype.setCalculator=t.prototype.setCalculator;t.prototype.setGridSize=t.prototype.setGridSize;t.prototype.setMaxZoom=t.prototype.setMaxZoom;t.prototype.onAdd=t.prototype.onAdd;t.prototype.draw=t.prototype.draw;n.prototype.getCenter=n.prototype.getCenter;n.prototype.getSize=n.prototype.getSize;n.prototype.getMarkers=n.prototype.getMarkers;r.prototype.onAdd=r.prototype.onAdd;r.prototype.draw=r.prototype.draw;r.prototype.onRemove=r.prototype.onRemove})(jQuery)